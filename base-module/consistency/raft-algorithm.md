---
description: Raft ç®—æ³•èƒ½å¤Ÿè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§é—®é¢˜
---

# Raft ç®—æ³•

## Raft ç®—æ³•æ¦‚å¿µ

Raft ç®—æ³•æ˜¯ç”±æ–¯å¦ç¦å¤§å­¦æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼åè®®ï¼Œç›¸æ¯” Paxos è€Œè¨€æ›´åŠ çš„å®¹æ˜“ç†è§£ã€‚Raft ç®—æ³•æ˜¯ä»å¤šå‰¯æœ¬çŠ¶æ€æœºçš„è§’åº¦å‡ºå‘ï¼Œå®ƒç”¨æ¥ç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ä»è€Œå®ç°äº†å’Œ Paxos åŒæ ·çš„åŠŸèƒ½ã€‚

ä¹‹æ‰€ä»¥ Raft ç®—æ³•ç›¸å¯¹ Paxos ç®—æ³•æ›´åŠ å®¹æ˜“ç†è§£ï¼ŒåŸå› æ˜¯ Raft ç®—æ³•å°†å¤æ‚çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æ‹†è§£ä¸ºå‡ ä¸ªå­é—®é¢˜ï¼š

* Leader é€‰ä¸¾ï¼ˆLeader electionï¼‰
* æ—¥å¿—åŒæ­¥ï¼ˆLog replicaitonï¼‰
* å®‰å…¨æ€§ï¼ˆSafetyï¼‰
* æ—¥å¿—å‹ç¼©ï¼ˆLog compactionï¼‰
* æˆå‘˜å˜æ›´ï¼ˆMembership changeï¼‰

æ­¤å¤–ï¼Œç›¸æ¯” Paxos ç›´æ¥ä»ä¸€è‡´æ€§åè®®æ¨å¯¼ï¼ŒRaft ç®—æ³•åˆ™ä½¿ç”¨äº†æ›´å¼ºçš„å‡è®¾æ¥å‡å°‘éœ€è¦è€ƒè™‘çš„çŠ¶æ€ï¼Œä»è€Œä½¿å…¶å˜å¾—æ›´åŠ å®¹æ˜“ç†è§£å’Œå®ç°ã€‚

{% hint style="warning" %}
å®é™…ä¸Šï¼Œå¦‚æœä½ ä¸ç†è§£ Paxos ç®—æ³•ä¹Ÿä¸éœ€è¦æ°”é¦ï¼Œå› ä¸ºå¼ºå¦‚æ–¯å¦ç¦å¤§å­¦å’ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„é«˜å¹´çº§æœ¬ç§‘ç”Ÿå’Œç ”ç©¶ç”Ÿåœ¨å­¦ä¹  Paxos ç®—æ³•æ—¶ä¹Ÿè§‰å¾—éš¾ä»¥ç†è§£ï¼›å› æ­¤ï¼Œå­¦ä¹ è¿™ç±»å¤æ‚çš„ä¸œä¸œéœ€è¦ä¸€æ­¥ä¸€ä¸ªè„šå°ï¼Œä¸å¯èƒ½ä¸€ä¸‹å­å°±åƒé€ï¼
{% endhint %}

## Raft ç®—æ³•ä¸­çš„è§’è‰²

Raft ç®—æ³•å°†ç³»ç»Ÿä¸­çš„è§’è‰²åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š

* **Leader**ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚å¹¶å‘ Follower åŒæ­¥è¯·æ±‚æ—¥å¿—ï¼Œå½“æ—¥å¿—åˆ°å¤§å¤§å¤šæ•°èŠ‚ç‚¹åå‘Šè¯‰ Follower æäº¤æ—¥å¿—
* **Follower**ï¼šæ¥å—å¹¶æŒä¹…åŒ– Leader åŒæ­¥çš„æ—¥å¿—ï¼Œåœ¨ Leader å‘ŠçŸ¥æ—¥å¿—å¯ä»¥æäº¤åæäº¤æ—¥å¿—
* **Candiadte**ï¼šLeader é€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²

![raft-role](../../.gitbook/assets/raft-role.jpg)

## Raft é€‰ä¸¾æµç¨‹

Raft è¦æ±‚ç³»ç»Ÿåœ¨ä»»æ„æ—¶åˆ»æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Leaderï¼Œæ­£å¸¸å·¥ä½œæœŸé—´åªèƒ½æœ‰ Leaderã€Followers è¿™ä¸¤ä¸ªè§’è‰²ï¼Œå…³äº Raft ç®—æ³•ç³»ç»Ÿä¸­çš„è§’è‰²çš„çŠ¶æ€æè¿°å³æµç¨‹å›¾å¦‚ä¸‹ï¼š

* å¼€å§‹ï¼Œæ‰€æœ‰æœåŠ¡å¯åŠ¨éƒ½æ˜¯ Followerï¼Œåœ¨ Follower è¶…æ—¶æ²¡æœ‰æ”¶åˆ° Leader å¿ƒè·³ä¹‹åï¼ŒFollower è¶…æ—¶ï¼ˆæ²¡æœ‰æ”¶åˆ°ä»»ä½•æ¥è‡ª Leader çš„å¿ƒè·³ï¼‰ï¼Œæ­¤æ—¶å®ƒä¼šæˆä¸ºä¸€ä¸ª Candidate å¹¶å¼€å§‹ä¸€æ¬¡ Leader é€‰ä¸¾
* åœ¨ election æœŸé—´å„ä¸ª Candidate å¼€å§‹æŠ•ç¥¨ election Leader
  * å¦‚æœåœ¨ Candidate æœŸé—´å‘ç°ä¸€ä¸ª Leader æˆ–å¼€å¯äº†ä¸€ä¸ªæ–°çš„ termï¼Œå®ƒå°±ä¼šä» Candidate å˜ä¸º Follower
* æ­¤æ—¶æ”¶åˆ°å¤§å¤šæ•°æœåŠ¡å™¨æŠ•ç¥¨çš„ Candidate ä¼šæˆä¸ºæ–°çš„ Leader
  * å¦‚æœç»ç”±æŠ•ç¥¨äº§ç”Ÿçš„ Leader å‘ç°åœ¨æ›´æ—©çš„ term å·²ç»äº§ç”Ÿäº†ä¸€ä¸ª Leader åˆ™æ­¤æ—¶å®ƒä¼šè½¬å˜ä¸º Follower

![raft-role-change](../../.gitbook/assets/raft-election.jpg)

> å¦‚æœä½ éœ€è¦åŠ¨æ€çš„æŸ¥çœ‹é€‰ä¸¾è¿™æ ·çš„æµç¨‹ï¼Œå¯ä»¥å‚è€ƒæ–‡æœ«çš„é“¾æ¥ [The Raft Consensus Algorithm](https://raft.github.io/)ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªé€‰ä¸¾çš„åŠ¨ç”»å¯ä»¥å¸®åŠ©ä½ ç†è§£ã€æ¶ˆåŒ– Raft çš„é€‰ä¸¾æµç¨‹ã€‚

![](../../.gitbook/assets/raft-election-gif.jpg)

{% hint style="danger" %}
æ­¤å¤–ï¼Œéœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„å‡ ç‚¹ï¼š
{% endhint %}

* Raft æ˜¯é€šè¿‡å¿ƒè·³ï¼ˆheartbeatï¼‰æ¥è§¦å‘é€‰ä¸¾æµç¨‹çš„ï¼›Leader å‘¨æœŸæ€§çš„å‘ Follower å‘é€å¿ƒè·³ä»è€Œç»´æŒå…¶ Leader åœ°ä½
* Follower ä¸ä¼šä¸»åŠ¨æå‡ºè¯·æ±‚ï¼Œåªæ˜¯å“åº” Leader å’Œ Candidate çš„è¯·æ±‚
* Leader è´Ÿè´£å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå‡å¦‚æŸä¸ªå®¢æˆ·ç«¯å…ˆè¿æ¥åˆ° Followerï¼Œé‚£ä¹ˆ Follower è¦è´Ÿè´£æŠŠè¿™ä¸ªå®¢æˆ·ç«¯é‡å®šå‘åˆ° Leaderï¼‰

## æ—¥å¿—åŒæ­¥

> Raft çš„æ—¥å¿—ç”±æ—¥å¿—æœ‰åºç¼–å·ï¼ˆlog indexï¼‰ç»„æˆï¼Œæ¯ä¸ªæ—¥å¿—æ¡ç›®ï¼ˆlog entriesï¼‰åŒ…å«äº†å®ƒè¢«åˆ›å»ºæ—¶çš„ä»»æœŸå·ï¼ˆtermï¼‰

åœ¨é€‰ä¸¾å‡º Leader ä¹‹åï¼ŒLeader å°±å¯ä»¥å¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚Leader æŠŠè¯·æ±‚ä½œä¸ºæ—¥å¿—æ¡ç›®ï¼ˆLog entriesï¼‰åŠ å…¥åˆ°å®ƒçš„æ—¥å¿—ä¸­ï¼Œç„¶åå¹¶è¡Œçš„å‘å…¶ä»–æœåŠ¡å™¨å‘èµ· AppendEntries RPC å¤åˆ¶è¿™äº›æ—¥å¿—æ¡ç›®ã€‚å½“è¿™äº›æ—¥å¿—è¢«å¤åˆ¶åˆ°å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šï¼ŒLeader å°†è¿™æ¡æ—¥å¿—åº”ç”¨åˆ°å®ƒçš„çŠ¶æ€æœºå¹¶å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡Œç»“æœï¼

\*\*\*\*ğŸŒ  **å¦‚æœæŸäº› Follower å¯èƒ½æ²¡æœ‰æˆåŠŸçš„å¤åˆ¶æ—¥å¿—ï¼ˆæ¯”å¦‚ Follower å®•æœºäº†ï¼‰ï¼ŒLeader ä¼šæ— é™çš„é‡è¯•ç›´åˆ°æ‰€æœ‰ Follower æœ€ç»ˆå­˜å‚¨äº†æ‰€æœ‰æ—¥å¿—æ¡ç›®**

![raft-log](../../.gitbook/assets/raft-log.jpg)



## å®‰å…¨æ€§



## æ—¥å¿—å‹ç¼©



## æˆå‘˜å˜æ›´



## Reference

* [The Raft Consensus Algorithm](https://raft.github.io/)
* [Raft Paper](https://raft.github.io/raft.pdf)
* [Raft ç®—æ³•è¯¦è§£](https://zhuanlan.zhihu.com/p/32052223)

